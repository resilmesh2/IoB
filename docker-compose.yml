services:
  # Attack Flow Builder Frontend
  attackflow_builder:
    build:
      context: ./attack_flow_builder
      dockerfile: Dockerfile
    container_name: attackflow_builder
    ports:
      - "9080:8080"
    networks:
      - resilmesh_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Sanic Web Server Backend
  sanic_web_server:
    build:
      context: ./sanic_web_server
      dockerfile: Dockerfile
    container_name: sanic_web_server
    ports:
      - "9003:8000"
    environment:
      - DEBUG=${DEBUG:-false}
      - PROJECT_ROOT=/app
      - BUILDER_PATH=/app/attack_flow_builder/dist
      - STIX_VIZ_PATH=/app/cti-stix-visualization
      - FLOW_DIR=/app/docs/attackflow_graphs
      - STORAGE_PATH=/app/alerts
      - STIX_STORAGE_PATH=/app/stix_bundles
    volumes:
      - ./sanic_web_server/docs:/app/docs
      - ./attack_flow_builder/dist:/app/attack_flow_builder/dist:ro
      - ./cti-stix-visualization:/app/cti-stix-visualization:ro
      - backend_alerts:/app/alerts
      - backend_stix:/app/stix_bundles
    networks:
      - resilmesh_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - attackflow_builder

  # STIX Modeler UI
  stix_modeler:
    build:
      context: ./UI
      dockerfile: Dockerfile
    container_name: stix_modeler
    ports:
      - "3400:3000"
    networks:
      - resilmesh_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

volumes:
  backend_alerts:
    driver: local
  backend_stix:
    driver: local